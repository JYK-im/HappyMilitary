<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°°ë‹¹í”½(Dividend Pick) | ì‹¤ì‹œê°„ íˆ¬ì ë°ì´í„°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #121418; color: #e1e1e1; overflow-x: hidden; }
        .accent-green { color: #2ecc71; }
        .bg-card { background-color: #1c1f26; border: 1px solid #2d333e; }
        .btn-green { background-color: #2ecc71; color: #121418; font-weight: bold; }
        .ipo-tag { background-color: #2ecc71; color: #121418; font-size: 9px; font-weight: bold; border-radius: 4px; padding: 1px 3px; display: block; margin-top: 2px; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-4 md:p-6">

    <header class="max-w-7xl mx-auto flex justify-between items-center py-4 mb-6 border-b border-gray-800">
        <div class="flex items-center gap-2">
            <div class="bg-[#2ecc71] p-2 rounded-lg"><i class="fa-solid fa-bolt text-black text-xl"></i></div>
            <h1 class="text-2xl font-black italic uppercase">Dividend <span class="accent-green">Pick</span></h1>
        </div>
        <div id="authArea" class="flex items-center gap-4">
            <button id="loginBtn" onclick="window.login()" class="text-xs bg-white text-black px-4 py-2 rounded-full font-bold">êµ¬ê¸€ ë¡œê·¸ì¸</button>
            <div id="userInfo" class="hidden flex items-center gap-2 text-sm font-bold">
                <span id="userNick" class="accent-green"></span>ë‹˜ 
                <button onclick="window.logout()" class="text-gray-500 text-xs underline ml-2">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto grid grid-cols-1 xl:grid-cols-4 gap-6">
        <div class="xl:col-span-1 space-y-6">
            <section class="bg-card p-6 rounded-xl min-h-[500px]">
                <h2 class="text-lg font-bold mb-4 italic uppercase"><i class="fa-solid fa-crown mr-2 accent-green"></i>Market Ranking</h2>
                <div id="rankingList" class="space-y-4 text-sm">
                    <p class="text-gray-500 text-center mt-10">ë°ì´í„° ë¡œë”© ì¤‘...</p>
                </div>
            </section>
        </div>

        <div class="xl:col-span-2 space-y-6">
            <section class="bg-card p-6 rounded-xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold italic uppercase"><i class="fa-solid fa-calendar-days mr-2 accent-green"></i>IPO Calendar</h2>
                    <div class="flex items-center gap-4 bg-black p-2 rounded-lg">
                        <button onclick="window.changeMonth(-1)" class="hover:text-green-500 px-2"><i class="fa-solid fa-chevron-left"></i></button>
                        <span id="currentDateLabel" class="font-bold text-lg min-w-[120px] text-center text-green-400"></span>
                        <button onclick="window.changeMonth(1)" class="hover:text-green-500 px-2"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 gap-px bg-gray-700 border border-gray-700 rounded-lg overflow-hidden text-[10px]">
                    <div class="bg-gray-800 p-2 text-center text-red-400">ì¼</div>
                    <div class="bg-gray-800 p-2 text-center text-gray-400">ì›”</div><div class="bg-gray-800 p-2 text-center text-gray-400">í™”</div>
                    <div class="bg-gray-800 p-2 text-center text-gray-400">ìˆ˜</div><div class="bg-gray-800 p-2 text-center text-gray-400">ëª©</div>
                    <div class="bg-gray-800 p-2 text-center text-gray-400">ê¸ˆ</div><div class="bg-gray-800 p-2 text-center text-blue-400">í† </div>
                </div>
            </section>
        </div>

        <div class="xl:col-span-1 space-y-6">
            <section class="bg-card p-5 rounded-xl h-[550px] flex flex-col relative">
                <h2 class="font-bold mb-4 accent-green italic uppercase"><i class="fa-solid fa-comments mr-2"></i>Live Talk</h2>
                <div id="msgBox" class="flex-1 overflow-y-auto space-y-3 mb-4 text-xs scrollbar-hide"></div>
                
                <div id="chatLock" class="absolute inset-0 bg-black/80 flex flex-col items-center justify-center p-6 text-center z-10 rounded-xl">
                    <p class="text-sm font-bold mb-4">ë¡œê·¸ì¸ í›„ ì°¸ì—¬ ê°€ëŠ¥</p>
                    <button onclick="window.login()" class="btn-green px-6 py-2 rounded-full text-xs">êµ¬ê¸€ ë¡œê·¸ì¸</button>
                </div>

                <div id="chatInputArea" class="hidden flex flex-col gap-2">
                    <input type="text" id="msg" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" class="bg-black border border-gray-700 p-2 rounded text-sm outline-none focus:border-green-500">
                    <button onclick="window.sendMsg()" class="btn-green w-full py-2 rounded text-sm">ì „ì†¡</button>
                </div>
            </section>
        </div>
    </main>

    <div id="profileModal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-900 p-8 rounded-2xl border border-gray-700 max-w-sm w-full">
            <h3 class="text-xl font-bold mb-6 text-center italic text-green-400">USER PROFILE</h3>
            <div class="space-y-4">
                <select id="userGender" class="w-full bg-black border border-gray-700 p-3 rounded-lg text-white">
                    <option value="ë‚¨ì„±">ë‚¨ì„±</option><option value="ì—¬ì„±">ì—¬ì„±</option>
                </select>
                <select id="userAge" class="w-full bg-black border border-gray-700 p-3 rounded-lg text-white">
                    <option value="20ëŒ€">20ëŒ€</option><option value="30ëŒ€">30ëŒ€</option>
                    <option value="40ëŒ€">40ëŒ€</option><option value="50ëŒ€+">50ëŒ€ ì´ìƒ</option>
                </select>
                <button onclick="window.saveProfile()" class="w-full btn-green py-3 rounded-lg mt-4">ì €ì¥ í›„ ì‹œì‘</button>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDaNmDpDXgiuELEO65Wk0PazVT2yeQeags",
        authDomain: "dividend-b090d.firebaseapp.com",
        projectId: "dividend-b090d",
        storageBucket: "dividend-b090d.firebasestorage.app",
        messagingSenderId: "543720180150",
        appId: "1:543720180150:web:15073a1e9706bb1f949917"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null, userData = null, viewDate = new Date(), apiCache = [];

    window.login = () => signInWithPopup(auth, provider);
    window.logout = () => signOut(auth);
    window.changeMonth = (v) => { viewDate.setMonth(viewDate.getMonth() + v); renderAll(); };

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            const snap = await getDoc(doc(db, "users", user.uid));
            if (!snap.exists()) document.getElementById('profileModal').classList.remove('hidden');
            else { userData = snap.data(); activateUI(); }
        } else deactivateUI();
    });

    window.saveProfile = async () => {
        userData = { name: currentUser.displayName, gender: document.getElementById('userGender').value, age: document.getElementById('userAge').value };
        await setDoc(doc(db, "users", currentUser.uid), userData);
        document.getElementById('profileModal').classList.add('hidden');
        activateUI();
    };

    function activateUI() {
        document.getElementById('chatLock').classList.add('hidden');
        document.getElementById('chatInputArea').classList.remove('hidden');
        document.getElementById('userInfo').classList.remove('hidden');
        document.getElementById('loginBtn').classList.add('hidden');
        document.getElementById('userNick').innerText = currentUser.displayName;
    }
    function deactivateUI() {
        document.getElementById('chatLock').classList.remove('hidden');
        document.getElementById('chatInputArea').classList.add('hidden');
        document.getElementById('userInfo').classList.add('hidden');
        document.getElementById('loginBtn').classList.remove('hidden');
    }

    // --- API ë°ì´í„° ë¡œë“œ (í”„ë¡ì‹œ ê°•í™”) ---
    async function loadData() {
        const sKey = "uDGP%2FFa5Y1fGcPUKw0BZ1Xsk2GDQnvbkgBhc9X4UjhWn7dr51gy94ulb7ZwLJDzp6sAJ7k5JR00SSAtC3sagrw%3D%3D";
        const url = `https://apis.data.go.kr/1160100/service/GetStocIssuInfoService_V2/getIpoTabInfo?serviceKey=${sKey}&resultType=json&numOfRows=100`;
        
        try {
            // AllOriginsê°€ ì‹¤íŒ¨í•  ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ì§ì ‘ í˜¸ì¶œ ì‹œë„ ë° íƒ€ì„ì•„ì›ƒ ì„¤ì •
            const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
            const json = await res.json();
            const data = JSON.parse(json.contents);
            apiCache = data.response.body.items.item || [];
        } catch (e) {
            console.warn("API ë¡œë“œ ì‹¤íŒ¨, ìƒ˜í”Œ ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.");
            // ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ ì‹œ ë³´ì—¬ì¤„ ìµœì†Œí•œì˜ ìƒ˜í”Œ ë°ì´í„°
            apiCache = [{ corpNm: "ì‚¼ì„±ì „ì(ì˜ˆì‹œ)", ipoPrcLow: "75000", subscrptStrtDt: "20251215" }];
        }
        renderAll();
    }

    function renderAll() { renderRanking(); renderCalendar(); }

    function renderRanking() {
        const list = document.getElementById('rankingList');
        const sorted = [...apiCache].sort((a,b) => b.ipoPrcLow - a.ipoPrcLow).slice(0, 10);
        list.innerHTML = sorted.map((item, i) => `
            <div class="flex justify-between items-center p-3 bg-black/40 rounded border border-gray-800">
                <span class="text-green-500 font-bold">${i+1}</span>
                <span class="flex-1 ml-3 font-bold text-xs truncate">${item.corpNm}</span>
                <span class="text-[10px] text-gray-400 font-mono">${parseInt(item.ipoPrcLow || 0).toLocaleString()}ì›</span>
            </div>
        `).join('');
    }

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const label = document.getElementById('currentDateLabel');
        const y = viewDate.getFullYear(), m = viewDate.getMonth();
        label.innerText = `${y}.${String(m+1).padStart(2,'0')}`;
        while(grid.children.length > 7) grid.removeChild(grid.lastChild);
        
        const first = new Date(y, m, 1).getDay(), last = new Date(y, m+1, 0).getDate();
        for(let i=0; i<first; i++) grid.appendChild(document.createElement('div')).className="bg-gray-900/20 h-16 border-r border-b border-gray-800";
        for(let i=1; i<=last; i++) {
            const day = document.createElement('div');
            day.className = "bg-[#1c1f26] h-16 border-r border-b border-gray-800 p-1";
            const dStr = `${y}${String(m+1).padStart(2,'0')}${String(i).padStart(2,'0')}`;
            const matches = apiCache.filter(d => String(d.subscrptStrtDt) === dStr);
            day.innerHTML = `<span class="text-gray-500">${i}</span>` + matches.map(d => `<div class="ipo-tag truncate text-[8px]">ğŸ“¢ ${d.corpNm}</div>`).join('');
            grid.appendChild(day);
        }
    }

    // --- ì±„íŒ… ë¡œì§ ---
    window.sendMsg = async () => {
        const msg = document.getElementById('msg').value;
        if (!msg || !currentUser) return;
        await addDoc(collection(db, "chats"), {
            nick: currentUser.displayName,
            msg, gender: userData.gender, age: userData.age, time: serverTimestamp()
        });
        document.getElementById('msg').value = "";
    };

    onSnapshot(query(collection(db, "chats"), orderBy("time", "asc")), (snap) => {
        const box = document.getElementById('msgBox');
        box.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data();
            box.innerHTML += `<div class="bg-gray-800/40 p-2 rounded border border-gray-700/50">
                <div class="flex items-center gap-1 mb-1">
                    <span class="text-green-400 font-bold">${d.nick}</span>
                    <span class="text-[9px] text-gray-500 bg-black/50 px-1 rounded">${d.age || '?'}/${d.gender || '?'}</span>
                </div>
                <div class="text-gray-300 leading-relaxed">${d.msg}</div>
            </div>`;
        });
        box.scrollTop = box.scrollHeight;
    });

    loadData();
</script>
</body>
</html>
