<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°°ë‹¹í”½(Dividend Pick) | ì‹¤ì‹œê°„ íˆ¬ì ë°ì´í„°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #121418; color: #e1e1e1; overflow-x: hidden; }
        .accent-green { color: #2ecc71; }
        .bg-card { background-color: #1c1f26; border: 1px solid #2d333e; }
        .btn-green { background-color: #2ecc71; color: #121418; font-weight: bold; }
        .ipo-tag { background-color: #2ecc71; color: #121418; font-size: 9px; font-weight: bold; border-radius: 4px; padding: 1px 3px; display: block; margin-top: 2px; }
    </style>
</head>
<body class="p-4 md:p-6">

    <header class="max-w-7xl mx-auto flex justify-between items-center py-4 mb-6 border-b border-gray-800">
        <div class="flex items-center gap-2">
            <div class="bg-[#2ecc71] p-2 rounded-lg"><i class="fa-solid fa-bolt text-black text-xl"></i></div>
            <h1 class="text-2xl font-black italic uppercase">Dividend <span class="accent-green">Pick</span></h1>
        </div>
        <div id="authArea" class="flex items-center gap-4">
            <button id="loginBtn" onclick="window.login()" class="text-xs bg-white text-black px-4 py-2 rounded-full font-bold">êµ¬ê¸€ ë¡œê·¸ì¸</button>
            <div id="userInfo" class="hidden flex items-center gap-2 text-sm font-bold text-green-400">
                <span id="userNick"></span>ë‹˜ <button onclick="window.logout()" class="text-gray-500 text-xs underline ml-2">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto grid grid-cols-1 xl:grid-cols-4 gap-6">
        <div class="xl:col-span-1">
            <section class="bg-card p-6 rounded-xl min-h-[550px]">
                <h2 class="text-lg font-bold mb-4 italic uppercase text-green-400 border-b border-gray-800 pb-2">Market Ranking</h2>
                <div id="rankingList" class="space-y-3">
                    <p class="text-gray-500 text-center py-20 animate-pulse text-xs">ë°ì´í„° ë™ê¸°í™” ì¤‘...</p>
                </div>
            </section>
        </div>

        <div class="xl:col-span-2">
            <section class="bg-card p-6 rounded-xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold italic uppercase"><i class="fa-solid fa-calendar-days mr-2 accent-green"></i>IPO Calendar</h2>
                    <div class="flex items-center gap-4 bg-black p-2 rounded-lg border border-gray-800">
                        <button onclick="window.changeMonth(-1)" class="hover:text-green-500 px-2"><i class="fa-solid fa-chevron-left"></i></button>
                        <span id="currentDateLabel" class="font-bold text-lg min-w-[120px] text-center text-green-400"></span>
                        <button onclick="window.changeMonth(1)" class="hover:text-green-500 px-2"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 gap-px bg-gray-800 border border-gray-800 rounded-lg overflow-hidden text-[10px]">
                    <div class="bg-gray-900 p-2 text-center text-red-500">ì¼</div>
                    <div class="bg-gray-900 p-2 text-center">ì›”</div><div class="bg-gray-900 p-2 text-center">í™”</div>
                    <div class="bg-gray-900 p-2 text-center">ìˆ˜</div><div class="bg-gray-900 p-2 text-center">ëª©</div>
                    <div class="bg-gray-900 p-2 text-center">ê¸ˆ</div><div class="bg-gray-900 p-2 text-center text-blue-500">í† </div>
                </div>
            </section>
        </div>

        <div class="xl:col-span-1">
            <section class="bg-card p-5 rounded-xl h-[550px] flex flex-col relative">
                <h2 class="font-bold mb-4 accent-green italic uppercase border-b border-gray-800 pb-2">Live Talk</h2>
                <div id="msgBox" class="flex-1 overflow-y-auto space-y-3 mb-4 text-[11px] pr-2"></div>
                
                <div id="chatLock" class="absolute inset-0 bg-black/80 flex flex-col items-center justify-center p-6 text-center z-10 rounded-xl">
                    <p class="text-xs font-bold mb-4 text-gray-400">ì‹¤ì‹œê°„ ì±„íŒ… ì°¸ì—¬ë¥¼ ìœ„í•´<br>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                    <button onclick="window.login()" class="btn-green px-6 py-2 rounded-full text-xs">êµ¬ê¸€ ë¡œê·¸ì¸</button>
                </div>

                <div id="chatInputArea" class="hidden flex flex-col gap-2">
                    <input type="text" id="msg" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." class="bg-black border border-gray-700 p-2 rounded text-sm outline-none focus:border-green-500 transition-all">
                    <button onclick="window.sendMsg()" class="btn-green w-full py-2 rounded text-sm uppercase">Send</button>
                </div>
            </section>
        </div>
    </main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDaNmDpDXgiuELEO65Wk0PazVT2yeQeags",
        authDomain: "dividend-b090d.firebaseapp.com",
        projectId: "dividend-b090d",
        storageBucket: "dividend-b090d.firebasestorage.app",
        messagingSenderId: "543720180150",
        appId: "1:543720180150:web:15073a1e9706bb1f949917"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    let viewDate = new Date();
    let ipoData = [];

    // ì „ì—­ í•¨ìˆ˜ ì—°ê²°
    window.login = () => signInWithPopup(auth, provider);
    window.logout = () => signOut(auth);
    window.changeMonth = (v) => { viewDate.setMonth(viewDate.getMonth() + v); renderAll(); };

    // ì¸ì¦ ì²˜ë¦¬
    onAuthStateChanged(auth, (user) => {
        if(user) {
            document.getElementById('chatLock').classList.add('hidden');
            document.getElementById('chatInputArea').classList.remove('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('userNick').innerText = user.displayName;
        } else {
            document.getElementById('chatLock').classList.remove('hidden');
        }
    });

    // ì‹¤ì œ ë°ì´í„° ê°•ì œ ë¡œë”© (ë‹¤ì¤‘ í”„ë¡ì‹œ ì „ëµ)
    // --- [ë°ì´í„° ë¡œë“œ ë¶€ë¶„ë§Œ ì´ ì½”ë“œë¡œ êµì²´í•˜ì„¸ìš”] ---

async function fetchIPOData() {
    const list = document.getElementById('rankingList');
    // ê³µê³µë°ì´í„°í¬í„¸ì—ì„œ ë°›ì€ 'Decoding' ì¸ì¦í‚¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    const serviceKey = "uDGP/Fa5Y1fGcPUKw0BZ1Xsk2GDQnvbkgBhc9X4UjhWn7dr51gy94ulb7ZwLJDzp6sAJ7k5JR00SSAtC3sagrw==";
    const baseUrl = "https://apis.data.go.kr/1160100/service/GetStocIssuInfoService_V2/getIpoTabInfo";
    
    // ì£¼ì†Œ ì¡°ë¦½ (ì¸ì½”ë”© ì¡°ì‹¬)
    const queryParams = `?serviceKey=${encodeURIComponent(serviceKey)}&resultType=json&numOfRows=50&pageNo=1`;
    const fullUrl = baseUrl + queryParams;

    // í”„ë¡ì‹œ ì„œë²„ ëª©ë¡ (í•˜ë‚˜ê°€ ì•ˆë˜ë©´ ë‹¤ìŒ ê²ƒì„ ì‚¬ìš©)
    const proxies = [
        `https://api.allorigins.win/get?url=${encodeURIComponent(fullUrl)}`,
        `https://cors-anywhere.herokuapp.com/${fullUrl}`,
        fullUrl // ì§ì ‘ í˜¸ì¶œ (ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš©)
    ];

    for (let proxyUrl of proxies) {
        try {
            const res = await fetch(proxyUrl);
            if (!res.ok) throw new Error("ë„¤íŠ¸ì›Œí¬ ì‘ë‹µ ì—†ìŒ");
            
            let data;
            if (proxyUrl.includes("allorigins")) {
                const json = await res.json();
                data = JSON.parse(json.contents);
            } else {
                data = await res.json();
            }

            if (data?.response?.body?.items?.item) {
                ipoData = data.response.body.items.item;
                console.log("ì‹¤ì œ ë°ì´í„° ìˆ˜ì‹  ì„±ê³µ:", ipoData.length, "ê±´");
                renderAll();
                return; // ì„±ê³µ ì‹œ í•¨ìˆ˜ ì¢…ë£Œ
            }
        } catch (e) {
            console.warn(`ì ‘ì† ì‹œë„ ì‹¤íŒ¨ (${proxyUrl}):`, e.message);
            continue; // ë‹¤ìŒ í”„ë¡ì‹œ ì‹œë„
        }
    }

    // ëª¨ë“  ì‹œë„ ì‹¤íŒ¨ ì‹œ
    list.innerHTML = "<p class='text-red-500 text-center text-xs'>ë°ì´í„° ì„œë²„ ì ê²€ ì¤‘ì…ë‹ˆë‹¤.<br>ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>";
}

    function renderAll() {
        renderRanking();
        renderCalendar();
    }

    function renderRanking() {
        const list = document.getElementById('rankingList');
        // ì‹¤ì œ ë°ì´í„°ê°€ ìˆì„ ê²½ìš°ì—ë§Œ ë Œë”ë§
        if(ipoData.length === 0) return;
        
        const top = [...ipoData].sort((a,b) => (b.ipoPrcLow||0) - (a.ipoPrcLow||0)).slice(0, 10);
        list.innerHTML = top.map((d, i) => `
            <div class="flex items-center justify-between p-3 bg-black/30 rounded-lg border border-gray-800 hover:border-green-500 transition-colors">
                <span class="text-green-500 font-bold w-6">0${i+1}</span>
                <span class="flex-1 font-bold text-xs truncate mx-2">${d.corpNm}</span>
                <span class="text-[10px] text-gray-400">${parseInt(d.ipoPrcLow || 0).toLocaleString()}ì›</span>
            </div>
        `).join('');
    }

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const label = document.getElementById('currentDateLabel');
        const y = viewDate.getFullYear(), m = viewDate.getMonth();
        label.innerText = `${y}.${String(m+1).padStart(2,'0')}`;

        while(grid.children.length > 7) grid.removeChild(grid.lastChild);
        const first = new Date(y, m, 1).getDay(), last = new Date(y, m+1, 0).getDate();

        for(let i=0; i<first; i++) grid.appendChild(document.createElement('div')).className="bg-gray-900/20 h-20 border-r border-b border-gray-800";
        for(let i=1; i<=last; i++) {
            const day = document.createElement('div');
            day.className = "bg-[#1c1f26] h-20 border-r border-b border-gray-800 p-1 overflow-y-auto";
            const dStr = `${y}${String(m+1).padStart(2,'0')}${String(i).padStart(2,'0')}`;
            const matches = ipoData.filter(d => String(d.subscrptStrtDt) === dStr);
            day.innerHTML = `<span class="${matches.length > 0 ? 'text-green-400 font-bold' : 'text-gray-500'}">${i}</span>` + 
                            matches.map(d => `<div class="ipo-tag truncate text-[8px] mt-1">ğŸ“¢ ${d.corpNm}</div>`).join('');
            grid.appendChild(day);
        }
    }

    // ì±„íŒ… ê¸°ëŠ¥
    window.sendMsg = async () => {
        const txt = document.getElementById('msg').value;
        if(!txt || !auth.currentUser) return;
        await addDoc(collection(db, "chats"), {
            nick: auth.currentUser.displayName,
            msg: txt,
            time: serverTimestamp()
        });
        document.getElementById('msg').value = "";
    };

    onSnapshot(query(collection(db, "chats"), orderBy("time", "asc")), (snap) => {
        const box = document.getElementById('msgBox');
        box.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data();
            box.innerHTML += `<div class="bg-gray-800/50 p-2 rounded border border-gray-700">
                <p class="text-green-400 font-bold mb-1">${d.nick}</p>
                <p class="text-gray-300">${d.msg}</p>
            </div>`;
        });
        box.scrollTop = box.scrollHeight;
    });

    fetchIPOData();
</script>
</body>
</html>

